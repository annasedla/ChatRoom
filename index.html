<!doctype html>
<html>
<head>
  <link href="normalize.css" rel="stylesheet">
  <title>Socket.IO chat</title>
  <style>
  @import url('https://fonts.googleapis.com/css?family=Roboto');    

  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }

  body { 
    font-family: 'Roboto', sans-serif;
  }

  form { 
    background: #000; 
    padding: 8px; 
    position: fixed; 
    bottom: 10; 
    width: 100%; 
  }

  form input { 
    border: 0; 
    border-radius: 25px;
    padding: 10px; 
    width: 90%; 
    margin-right: .5%; 
  }

  button { 
    border-radius: 25px;
    width: 9%; 
    background: rgb(0, 168, 107); 
    border: none; 
    padding: 10px; 
  }

  .messages { 
    list-style-type: none; 
    margin: 0; 
    padding: 0; 
  }

  .name{
    background:#F0F0F0;
    font-size:10pt;
    color:grey;
  }

  .mess {
    background:#FFFFFF;
    font-size:16pt;
    color:black;
  }

  .chat{
    border:solid;
    border-color:blue;
    border-radius:8px;
    font-size:20pt;
  }

  .user_event {
    background:#111111;
    font-size:10pt;
    color:red;
  }

  #messages li { 
    padding: 5px 10px; 
  }

  #messages li:nth-child(odd) { 
    background: #eee; 
  }
  </style>
</head>

<script> var name = prompt("Please enter your name", "AwesomeName"); </script>

<body>
  <ul id="messages"></ul>
  <form action="">
    <input id="m" autocomplete="off" /><button>Send</button>

    <div id="buttons" style="position:relative;">
      <input type='button' class='chat' value='Default' onclick="switch_chat('Default')" />
      <input type='button' class='chat' value='TestButtonTwo' onclick="switch_chat('test_chat_1')" />
    </div>
  </form>
</body>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>

<script>

$(function () {

  var socket = io();
  var this_log = [];
  var current_chat = 'Default';
  var all_chats = [];
  var formatted_chats = '';

  socket.emit('join chat', name);
  
  function switch_chat(newChat){
    local_log = [];
    $('#messages').html('');
    socket.emit('switch chat', newChat);
    current_chat = newChat;
    update_chats();

  }

    $('form').submit(function(){
      //socket.emit('chat message', $('#m').val());
      socket.emit('chat message', {name: name, to:current_chat, val: $('#m').val(), type:'chat message'} ); //TODO
      $('#m').val('');
      return false;
    });

    //chat messages
    //socket.on('chat message', function(msg){
      //$('#messages').append($('<li>').text(msg));
    //});

        
    socket.on('chat message', function(msg){
      this_log.push({type:'chat message' , val:msg});
      var messages = $('#messages').html();
      var newMess = "<li>";
      if(this_log.length > 0 && this_log[this_log.length-1].type == 'chat message' && this_log[this_log.length-2].val.name == msg.name){ 
      } else {
        newMess = newMess + "<div class='name'>" + msg.name + "</div>";
      }
      newMess = newMess+ "<div class='mess'>" +msg.val + "</div></li>";
      $('#messages').html(messages + newMess);
      window.scrollTo(0,document.body.scrollHeight);
    });

    //user event
    socket.on('user event', function(msg){
      this_log.push({type:'user event' , val:msg});
      var messages = $('#messages').html();
      var newMess = "<li><div class='user_event'>" + msg.val + "</div></li>";
      $('#messages').html(messages + newMess);
    });

    //update chats
    socket.on('update chats', function(chats){
      all_chats = chats;
      update_chats();
    });


    function update_chats(){
      //update chat buttons
      var displayed_chats = [];
      for (var i = 0; i < all_chats.length; i++){
        if (all_chats[i] != current_chat){
          displayed_chats.push(all_chats[i]);
        }
      }

      for (var i = 0; i < displayed_chats.length; i++){
        formatted_chats = formatted_chats + "<input type ='button' class ='chat' value = '" + displayed_chats[i] +"' onclick=\"switch_chat('" + displayed_chats[i]+"')\" />";
        //$("#i").oclick()
      }

      $('#buttons').html(formatted_chats);
    }
  });

</script>
